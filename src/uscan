#!/bin/bash
# Uses debian's uscan utility to download newer versions of ISOs when they become available.
#
# Check for updates, but don't write anything:
#   ./uscan
# Download updates and update .version files
#   USCAN_OPTS=--force-download ./uscan
# Debug any problems:
#   USCAN_OPTS=--debug ./uscan
#
# TODO: spurious tarballs being created, fixed by https://salsa.debian.org/debian/devscripts/-/merge_requests/603

cd "$(dirname "$0")"

BINPATH="../bin"

uscan_watch() {
	local package="${1%.watch}"
	local version=0
	if [ -f "${package}.version" ]; then
		binfile="$(cut -f2 "${package}.version")"
		version="$(cut -f1 ${package}.version)"
		if ! [ -f "$binfile" -o -f "${binfile%.*}" ]; then
			echo >&2 "$0: recorded version $version not found as ${binfile} or ${binfile%.*}"
			version=
		fi
	fi
	test -z "$debug" || set -x
	uscan $USCAN_OPTS --dehs \
	  --watchfile "${package}.watch" --package "$package" --upstream-version "$version" \
	  --no-symlink --destdir "$BINPATH" | python -c '
import xml.etree.ElementTree as ET
import sys
tree = ET.parse(sys.stdin)
root = tree.getroot()
ver = root.find("upstream-version")
path = root.find("target-path")
if ver is not None and path is not None:
	with open("'"${package}"'.version", "w") as fp:
		print("%s\t%s" % (ver.text, path.text), file=fp)
'
	{ test -z "$debug" || set +x; } 2>/dev/null
}

names=()
for arg in "$@"; do
	case "$arg" in
	--debug)
		debug=1;;
	--no-debug)
		debug=;;
	--verbose)
		verbose=1;;
	--no-verbose)
		verbose=;;
	--download)
		download=1;;
	--no-download)
		download=;;
	*.watch)
		names+=( "$arg" );;
	*.version)
		names+=( "${arg%.version}.watch" );;
	*)
		names+=( "${arg}.watch" );;
	esac
done

if [ -n "$debug" ]; then
	USCAN_OPTS="${USCAN_OPTS} --debug"
fi
if [ -n "$verbose" ]; then
	USCAN_OPTS="${USCAN_OPTS} --verbose"
fi
if [ -n "$download" ]; then
	# uscan specifically ignores --download for the specific case of how we're using it, unfortunately
	USCAN_OPTS="${USCAN_OPTS} --force-download"
fi
if [[ "${#names[@]}" -eq 0 ]]; then
	names+=( *.watch )
fi

if [ -n "$debug" ]; then
	echo >&2 "USCAN_OPTS: $USCAN_OPTS"
	echo >&2 "names: ${names[@]}"
fi
len=$(for i in "${names[@]}"; do echo "${#i}"; done | sort -n | tail -n1)
for i in "${names[@]}"; do
	( prefix=$(printf "%--$((len - 6))s | " "${i%.watch}"); uscan_watch "$i" 2>&1 | sed -e "s/^/$prefix/" ) &
done
wait
