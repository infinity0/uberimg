#!/bin/bash
# Uses debian's uscan utility to download newer versions of ISOs when they become available.
#
# Check for updates, but don't write anything:
#   ./uscan
# Download updates and update .version files
#   USCAN_OPTS=--force-download ./uscan
# Debug any problems:
#   USCAN_OPTS=--debug ./uscan
#
# TODO: spurious tarballs being created, fixed by https://salsa.debian.org/debian/devscripts/-/merge_requests/603

cd "$(dirname "$0")"

BINPATH="../bin"

case "$USCAN_OPTS" in
*--download*)
	echo >&2 "$0: \"USCAN_OPTS=--download\" has no effect due to the way we run uscan, converting it to --force-download instead"
	USCAN_OPTS="${USCAN_OPTS/--download/--force-download}"
	;;
esac

uscan_watch() {
	local package="${1%.watch}"
	local version=0
	if [ -f "${package}.version" ]; then
		if [ -f "$BINPATH/$(cut -f2 ${package}.version)" ]; then
			version="$(cut -f1 ${package}.version)"
		fi
	fi
	uscan $USCAN_OPTS --dehs \
	  --watchfile "$package.watch" --package "$package" --upstream-version "$version" \
	  --no-symlink --destdir "$BINPATH" | python -c '
import xml.etree.ElementTree as ET
import sys
tree = ET.parse(sys.stdin)
root = tree.getroot()
ver = root.find("upstream-version")
path = root.find("target-path")
if ver is not None and path is not None:
	with open("'"${package}"'.version", "w") as fp:
		print("%s\t%s" % (ver.text, path.text), file=fp)
'
}

case "$1" in
"")
	len=$(for i in *.watch; do echo "${#i}"; done | sort -n | tail -n1)
	for i in *.watch; do
		( prefix=$(printf "%--$((len - 6))s | " "${i%.watch}"); uscan_watch "$i" | sed -e "s/^/$prefix/" ) &
	done
	wait
	;;
*)
	if [ -f "$1" ]; then
		uscan_watch "${1%.version}"
	else
		exit 2
	fi
	;;
esac
